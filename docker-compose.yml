version: '3.8'

networks:
  censudex-net:
    driver: bridge

services:
  # --- BASES DE DATOS ---

  postgres-db:
    image: postgres:latest
    container_name: censudex-postgres
    # Se recomienda cambiar la contraseña en Prod, pero la mantengo por consistencia
    environment:
      - POSTGRES_PASSWORD=tu_password 
      - POSTGRES_USER=postgres
      - POSTGRES_DB=censudex_clients # Base de datos principal para clientes/usuarios
    ports:
      - "5432:5432"
    networks:
      - censudex-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d censudex_clients"]
      interval: 5s
      timeout: 5s  
      retries: 5 

  redis-db:
    image: redis:latest
    container_name: censudex-redis
    ports:
      - "6379:6379"
    networks:
      - censudex-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- MICROSERVICIOS DE LÓGICA CORE ---

  clients-service:
    container_name: censudex-clients-service
    build:
      # Asumo que el Dockerfile está en la carpeta ClientsService
      context: ../censudex-clients-service/ClientsService 
    environment:
      - ConnectionStrings__DefaultConnection=Host=postgres-db;Port=5432;Database=censudex_clients;Username=postgres;Password=tu_password
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - censudex-net
    depends_on:
      postgres-db:
        condition: service_healthy

  auth-service:
    container_name: censudex-auth-service
    build:
      context: ../censudex-auth-service/AuthService
    environment:
      - Redis__ConnectionString=redis-db:6379
      - ServiceUrls__ClientsService=http://clients-service:8080
      - ASPNETCORE_URLS=http://+:8080
      - Jwt__Key=ESTE_ES_UN_SECRETO_MUY_LARGO_Y_SEGURO_QUE_DEBES_CAMBIAR
      - Jwt__Issuer=censudex-auth-service
      - Jwt__Audience=censudex-microservices
    networks:
      - censudex-net
    depends_on:
      clients-service:
        condition: service_started 
      redis-db:
        condition: service_healthy

  # --- NUEVOS MICROSERVICIOS (Orders, Products, Inventory) ---

  orders-service:
    container_name: censudex-orders-service
    build:
      # Asume que el Dockerfile está en la raíz de este proyecto
      context: ../censudex-orders-service 
    environment:
      - ASPNETCORE_URLS=http://+:8080 # Puerto de escucha gRPC/HTTP
      # Puedes necesitar una cadena de conexión a PostgreSQL aquí, si usa BD.
    networks:
      - censudex-net
    depends_on:
      clients-service:
        condition: service_started 

  products-service:
    container_name: censudex-products-service
    build:
      context: ../censudex-products-service # Ajusta esta ruta si es necesario
    environment:
      - ASPNETCORE_URLS=http://+:8080 
      # Puedes necesitar variables para el storage o BD de productos aquí.
    networks:
      - censudex-net

  inventory-service:
    container_name: censudex-inventory-service
    build:
      context: ../censudex-inventory-service # Ajusta esta ruta si es necesario
    environment:
      - ASPNETCORE_URLS=http://+:8080
      # Puedes necesitar variables para el storage o BD de inventario aquí.
    networks:
      - censudex-net
    depends_on:
      products-service:
        condition: service_started 

  # --- API GATEWAY & PROXY ---

  apigateway-service:
    container_name: censudex-apigateway-net
    build:
      context: ./ApiGatewayService
    environment:
      - ASPNETCORE_ENVIRONMENT=Production # Usa appsettings.Production.json
      - ASPNETCORE_URLS=http://+:8080
      # URLs para Docker (usando nombres de servicio)
      - ServiceUrls__ClientsService=http://clients-service:8080
      - ServiceUrls__AuthService=http://auth-service:8080
      - ProductsService__BaseUrl=http://products-service:8080
      - InventoryService__BaseUrl=http://inventory-service:8080
      - OrderService__BaseUrl=http://orders-service:8080
    networks:
      - censudex-net
    depends_on:
      auth-service:
        condition: service_started
      orders-service:
        condition: service_started
      inventory-service:
        condition: service_started
      products-service:
        condition: service_started

  nginx-loadbalancer:
    image: nginx:latest
    container_name: censudex-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - censudex-net
    depends_on:
      apigateway-service:
        condition: service_started