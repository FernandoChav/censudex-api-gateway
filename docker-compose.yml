
networks:
  censudex-net:
    driver: bridge

services:
  # --- BASES DE DATOS ---

  postgres-db:
    image: postgres:latest
    container_name: censudex-postgres
    environment:
      - POSTGRES_PASSWORD=tu_password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=censudex_clients
    ports:
      - "5432:5432"
    networks:
      - censudex-net

    healthcheck:
    
      test: ["CMD-SHELL", "pg_isready -U postgres -d censudex_clients"]
      interval: 5s  
      timeout: 5s   
      retries: 5    

  redis-db:
    image: redis:latest
    container_name: censudex-redis
    ports:
      - "6379:6379"
    networks:
      - censudex-net
   
    healthcheck:
     
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # --- MICROSERVICIOS DE LÃ“GICA ---

  clients-service:
    container_name: censudex-clients-service
    build:
      context: ../censudex-clients-service/ClientsService
    environment:
      - ConnectionStrings__DefaultConnection=Host=postgres-db;Port=5432;Database=censudex_clients;Username=postgres;Password=tu_password
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - censudex-net
  
    depends_on:
      postgres-db:
        condition: service_healthy

  auth-service:
    container_name: censudex-auth-service
    build:
      context: ../censudex-auth-service/AuthService
    environment:
      - Redis__ConnectionString=redis-db:6379
      - ServiceUrls__ClientsService=http://clients-service:8080
      - ASPNETCORE_URLS=http://+:8080
      - Jwt__Key=ESTE_ES_UN_SECRETO_MUY_LARGO_Y_SEGURO_QUE_DEBES_CAMBIAR
      - Jwt__Issuer=censudex-auth-service
      - Jwt__Audience=censudex-microservices
    networks:
      - censudex-net

    depends_on:
      clients-service:
        condition: service_started 
      redis-db:
        condition: service_healthy

  # --- API GATEWAY ---

  apigateway-service:
    container_name: censudex-apigateway-net
    build:
      context: ./ApiGatewayService
    environment:
      - ServiceUrls__ClientsService=http://clients-service:8080
      - ServiceUrls__AuthService=http://auth-service:8080
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - censudex-net
  
    depends_on:
      auth-service:
        condition: service_started 

  nginx-loadbalancer:
    image: nginx:latest
    container_name: censudex-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - censudex-net

    depends_on:
      apigateway-service:
        condition: service_started 